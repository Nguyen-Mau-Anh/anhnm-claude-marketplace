name: Validate Plugins

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate marketplace.json
        run: |
          if [ ! -f ".claude-plugin/marketplace.json" ]; then
            echo "Error: marketplace.json not found"
            exit 1
          fi
          echo "marketplace.json exists"
          cat .claude-plugin/marketplace.json | python3 -m json.tool > /dev/null
          echo "marketplace.json is valid JSON"

      - name: Validate plugin structure
        run: |
          # Read plugin paths from marketplace.json (source of truth)
          # This handles both nested (plugins/plugin-name/) and flattened (plugins/) structures
          python3 << 'EOF'
          import json
          import os
          import sys

          with open('.claude-plugin/marketplace.json') as f:
              data = json.load(f)

          for plugin in data['plugins']:
              plugin_name = plugin['name']
              plugin_path = plugin['source']
              print(f"Validating plugin: {plugin_name} (source: {plugin_path})")

              # Check plugin.json exists
              plugin_json = f"{plugin_path}/.claude-plugin/plugin.json"
              if not os.path.exists(plugin_json):
                  print(f"Error: {plugin_json} not found")
                  sys.exit(1)

              # Validate plugin.json is valid JSON
              try:
                  with open(plugin_json) as pf:
                      json.load(pf)
                  print("  - plugin.json is valid")
              except json.JSONDecodeError as e:
                  print(f"  - Error: plugin.json is invalid JSON: {e}")
                  sys.exit(1)

              # Check for README
              readme_path = f"{plugin_path}/README.md"
              if os.path.exists(readme_path):
                  print("  - README.md exists")
              else:
                  print("  - Warning: README.md not found")

              print(f"  Plugin {plugin_name} validated successfully")
          EOF

      - name: Check for required files
        run: |
          echo "Checking repository structure..."
          [ -f "README.md" ] && echo "  - README.md exists" || echo "  - Warning: README.md not found"
          [ -f ".gitignore" ] && echo "  - .gitignore exists" || echo "  - Warning: .gitignore not found"
          echo "Validation complete!"
